<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ page import="java.sql.Connection, java.sql.DriverManager, java.sql.PreparedStatement, java.sql.ResultSet" %>
<%@ page import="java.util.Properties, javax.mail.Session, javax.mail.internet.MimeMessage, javax.mail.Transport" %>
<%@ page import="java.security.MessageDigest" %>
<%@ page import="org.apache.commons.codec.binary.Hex" %>

<%@ page import="com.database.dbconn" %>

<% 
		if(request.getMethod().equalsIgnoreCase("POST")) {
        String fullName = request.getParameter("full-name");
        String email = request.getParameter("email");
        String contact = request.getParameter("contact");
        String userName = request.getParameter("user-name");
        String password = request.getParameter("password");
        
        // Perform password hashing
        MessageDigest digest = MessageDigest.getInstance("SHA-256");
        byte[] hashBytes = digest.digest(password.getBytes("UTF-8"));
        String hashedPassword = Hex.encodeHexString(hashBytes);
        
        // Database operations
        Connection conn = dbconn.getConnection();
        PreparedStatement statement = null;
        ResultSet resultSet = null;
        
        try {
                        
            // Check if user already exists
            String checkUserQuery = "SELECT user_name FROM user_details WHERE user_name = ?";
            statement = conn.prepareStatement(checkUserQuery);
            statement.setString(1, userName);
            resultSet = statement.executeQuery();
            
            if (resultSet.next()) {
                String errorMessage = "User name already exists. Please try another.";
                // Handle error message accordingly
            } else {
                // Insert user details
                String createUserQuery = "INSERT INTO user_details (full_name, email, contact, user_name, password) VALUES (fullName,email,contact,userName,password)";
                statement = conn.prepareStatement(createUserQuery);
                statement.setString(1, fullName);
                statement.setString(2, email);
                statement.setString(3, contact);
                statement.setString(4, userName);
                statement.setString(5, hashedPassword);
                statement.executeUpdate();
                
                String successMessage = "User created successfully.";
                
                // Send email
                String senderEmail = "sender_email@example.com";
                String senderPassword = "sender_password";
                String recipientEmail = email;
                String subject = "Welcome to Park Smart";
                String body = "Hello " + fullName + ",<br>You have used this email to sign up to Park Smart.<br><br>Regards,<br>Park Smart Team";
                
                Properties properties = System.getProperties();
                properties.setProperty("mail.smtp.host", "smtp.gmail.com");
                properties.setProperty("mail.smtp.port", "587");
            }
            }
        
            catch(Exception e)
            { System.out.println(e);
            }
          %>
    
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>User Registration</title>
    <script src="../Javascript/formValidation.js"></script>
</head>
<body>
    <h2>User Registration</h2>
       <form action="" method="POST" id="signUpForm" onsubmit="event.preventDefault();validation();">
            <label for="full-name">Full Name</label>
                <input type="text" id="full-name" placeholder="&#xf007;  Enter your full name" name="full-name"><br>
                <span id="full-name-validation" class="error-message"></span>
                <label for="email">Email</label>
                <input type="text" id="email" placeholder="&#xf0e0;  Enter your email" name="email"><br>
                <span id="email-validation" class="error-message"></span>
                <label for="contact">Contact</label>
                <input type="number" id="contact" placeholder="&#xf10b;  Enter your contact number" name="contact"><br>
                <span id="contact-validation" class="error-message"></span>
                <label for="user-name">User Name</label>
                <input type="text" id="user-name" placeholder="&#xf2c2;  Create a user name" name="user-name"><br>
                <span id="user-name-validation" class="error-message"></span>
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="&#xf084;  Create a password" name="password"><br>
                <span id="password-validation" class="error-message"></span>
                <label for="confirm-password">Confirm Password</label>
                <input type="password" id="confirm-password" placeholder="&#xf00c;&#xf084;  Confirm your password" name="confirm-password"><br>
                <span id="confirm-password-validation" class="error-message"></span>
                <span class="backend-error-message"><?= $error_message?></span>
                <span class="message"><?= $message?></span>
                <button type="submit">Register</button>
                <hr>
                <span style="text-align:center"><b>Already have an account</b></span>
                <a href="login.php"><button type="button">Proceed to Login</button></a>
            </form>           
</body>
</html>
